rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ USERS
    match /users/{userId} {
      // Anyone can read user docs (simpler for now; tighten later if needed)
      allow read: if true;

      // Authenticated user can create and fully manage their own document
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == userId;

      // Additionally, allow unauthenticated verification flow to perform a narrow update
      allow update: if isVerificationCompletion();
    }

    function isVerificationCompletion() {
      // Existing document must still be pending verification
      return resource.data.verificationToken != null &&
             resource.data.verificationTokenExpiry != null &&
             // The update can only touch verification-related fields in a specific way
             request.resource.data.verified == true &&
             request.resource.data.verificationToken == null &&
             request.resource.data.verificationTokenExpiry == null &&
             request.resource.data.verifiedAt != null &&
             // All other fields must remain unchanged
             request.resource.data.diff(resource.data).affectedKeys().hasOnly([
               "verified",
               "verificationToken",
               "verificationTokenExpiry",
               "verifiedAt"
             ]);
    }

    // ✅ HOST APPLICATIONS
    match /hostApplications/{applicationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if request.auth.token.role == "admin";
    }

    // ✅ LISTINGS
    match /listings/{listingId} {
      // Public can read published listings. Hosts and admins can read their own/all.
      allow read: if resource.data.status == "published" ||
                  (request.auth != null && (
                    resource.data.hostId == request.auth.uid ||
                    request.auth.token.role == "admin"
                  ));
      allow create: if request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ["host", "admin"]);
      allow update, delete: if request.auth != null && (
        resource.data.hostId == request.auth.uid ||
        request.auth.token.role == "admin"
      );
    }

    // ✅ BOOKINGS
    match /bookings/{bookingId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.guestId == request.auth.uid ||
        resource.data.hostId == request.auth.uid ||
        request.auth.token.role == "admin"
      );
    }

    // ✅ MESSAGES
    match /messages/{messageId} {
      allow read, create: if request.auth != null;
    }

    // ✅ CONVERSATIONS
    match /conversations/{conversationId} {
      // Allow create if the creating user is among participants
      allow create: if request.auth != null &&
        (request.resource.data.participants is list && request.auth.uid in request.resource.data.participants);
      // Read/update only if user is a participant
      allow read, update: if request.auth != null &&
        (resource.data.participants is list && request.auth.uid in resource.data.participants);
    }

    // ✅ PAYMENTS
    match /payments/{paymentId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth.token.role == "admin";
    }

    // ✅ REWARDS
    match /rewards/{rewardId} {
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // ✅ SUBSCRIPTIONS
    match /subscriptions/{userId} {
      // Each user can read and write their own subscription document
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
    }

    // ✅ AVAILABILITY
    match /availability/{availabilityId} {
      // Only owner host can manage their availability entries
      allow create: if request.auth != null && request.auth.uid == request.resource.data.hostId;
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;
    }
  }
}

